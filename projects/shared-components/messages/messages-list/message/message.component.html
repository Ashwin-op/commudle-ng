<div *ngIf="message" class="message-container">
  <div class="prefix d-flex align-items-start">
    <div class="avatar">
      <img alt="{{message.user.name}}" src="{{message.user.avatar}}" title="{{message.user.name}}">
    </div>
    <div class="user-container">
      <div class="user d-flex align-items-center">
        <a [routerLink]="['/users', message.user.username]" class="name">{{message.user.name}}</a>
        <img *ngIf="message.user.is_expert" alt="Expert Tick" class="expert-icon" src="/assets/images/Expert-Tick.svg"
             title="Expert Tick">
      </div>
      <p [nbTooltip]="moment(message.created_at).fromNow()" class="content" nbTooltipPlacement="left">
        {{message.content}}
      </p>
    </div>
  </div>
  <nb-actions class="suffix" size="tiny">
    <nb-action>
      <app-votes-display [votableId]="message.id" icon="heart-outline" size="small"
                         votableType="UserMessage"></app-votes-display>
    </nb-action>
    <nb-action *ngIf="permittedActions.includes(allActions.ADD) && canReply && currentUser">
      <nb-icon (click)="showReplyForm = !showReplyForm" class="clickable" icon="undo-outline"></nb-icon>
    </nb-action>
    <nb-action *ngIf="permittedActions.includes(allActions.DELETE) || message.user.id === currentUser?.id">
      <nb-icon (click)="emitDelete(message.id)" class="clickable" icon="trash-outline"
               nbTooltip="Delete this message"></nb-icon>
    </nb-action>
    <nb-action *ngIf="currentUser && permittedActions.includes(allActions.FLAG)">
      <p *ngIf="message.flags_count > 0">{{message.flags_count}}&nbsp;</p>
      <nb-icon (click)="emitFlag(message.id)" class="clickable" icon="flag-outline"
               nbTooltip="Report this message (3 reports deletes it)"></nb-icon>
    </nb-action>
  </nb-actions>
  <div *ngIf="canReply" class="replies">
    <app-message (sendDelete)="emitDelete($event)" (sendFlag)="emitFlag($event)"
                 *ngFor="let reply of message.user_messages" [allActions]="allActions" [canReply]="false"
                 [currentUser]="currentUser" [message]="reply" [permittedActions]="permittedActions"></app-message>
    <div *ngIf="showReplyForm" class="reply-form">
      <form (submit)="emitReply()" [formGroup]="replyForm">
        <nb-form-field>
          <input fieldSize="tiny" formControlName="content" fullWidth maxlength="200" minlength="1" nbInput
                 placeholder="Reply" type="text">
          <button [disabled]="!replyForm.valid" ghost nbButton nbSuffix size="tiny">
            <nb-icon icon="paper-plane"></nb-icon>
          </button>
        </nb-form-field>
      </form>
    </div>
  </div>
</div>
